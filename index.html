<html style="overflow:hidden; user-select:none;">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
<title>Pico</title>
<link rel="icon" type="image/png" href="icon.png">
<link rel="apple-touch-icon" href="icon.png" sizes="192x192">
<link rel="manifest" href="manifest.json">
<style>
body {
	font-family: Courier, monospace, sans-serif;
	background-color: #fff;
}
a {
	color: #ccc;
	text-decoration: none;
}
#container {
	width: 100%; height: 100%;
	display: flex; display: -webkit-flex;
	flex-direction: column; -webkit-flex-direction: column;
	justify-content: flex-start; -webkit-justify-content: flex-start;
	align-items: center; -webkit-align-items: center;
}
#header {
	margin: 0px;
	flex: 0 1 auto;
	display: flex; display: -webkit-flex;
	flex-direction: row; -webkit-flex-direction: row;
	justify-content: space-between; -webkit-justify-content: space-between;
	align-items: center; -webkit-align-items: center;
}
#contents {
	position: relative;
	width: 100%; height: 100%; margin: 8px;
	flex: 1 1 auto;
	display: flex; display: -webkit-flex;
	flex-direction: row; -webkit-flex-direction: row;
	justify-content: center; -webkit-justify-content: center;
	align-items: center; -webkit-align-items: center;
	background-color: #ccc;
}
#screen {
	aspect-ratio: 1;
}
#footer {
	width: 100%; height: 12px; margin-top: -8px;
	flex: 0 1 auto;
	display: flex; display: -webkit-flex;
	flex-direction: row; -webkit-flex-direction: row;
	justify-content: flex-end; -webkit-justify-content: flex-end;
	align-items: center; -webkit-align-items: center;
	font-size: 12px;
	color: #eee;
}
.logo {
	height: 60px; margin: 0px 16px;
	display: flex; display: -webkit-flex;
	flex-direction: row; -webkit-flex-direction: row;
	justify-content: flex-start; -webkit-justify-content: flex-start;
	align-items: center; -webkit-align-items: center;
}
.logo #icon {
	width: 40px; height: 40px; padding: 10px; margin-left: -28px;
}
.logo #title {
	font-size: 24px;
	color: #888;
}
.menu {
	display: flex; display: -webkit-flex;
	flex-direction: row; -webkit-flex-direction: row;
	justify-content: space-between; -webkit-justify-content: space-between;
	align-items: flex-end; -webkit-align-items: flex-end;
}
.menu .item {
	width: 40px; height: 40px; margin: 0px;
	display: flex; display: -webkit-flex;
	flex-direction: column; -webkit-flex-direction: column;
	justify-content: center; -webkit-justify-content: center;
	align-items: center; -webkit-align-items: center;
	font-size: 16px;
}
.menu .item.dark {
	background-color: #888;
	color: #fff;
}
.menu .light {;
	color: #888;
}
.menu .item.extra {
	background-color: #ccc;
	color: #fff;
}
.menu a {
	transform: scale(1);
	opacity: 1;
}
.menu a:hover {
	transform: scale(1);
	opacity: 0.6;
}
.menu a:active {
	transform: scale(0.9);
	opacity: 1;
}
@media (max-height: 400px) {
	#container {
		display: flex; display: -webkit-flex;
		flex-direction: row; -webkit-flex-direction: row;
		justify-content: flex-start; -webkit-justify-content: flex-start;
		align-items: center; -webkit-align-items: center;
	}
	#header {
		order: 1;
	}
	.logo {
		display: none;
		width: 0%;
	}
	.menu {
		flex-direction: column; -webkit-flex-direction: column;
		justify-content: center; -webkit-justify-content: center;
		align-items: center; -webkit-align-items: center;
	}
}
@media (min-height: 400px) {
	#header {
		width: 100%;
	}
}
@media (orientation: landscape) {
	#screen {
		height: 100%;
	}
}
@media (orientation: portrait) {
	#contents {
		display: flex; display: -webkit-flex;
		flex-direction: column; -webkit-flex-direction: column;
		justify-content: center; -webkit-justify-content: center;
		align-items: center; -webkit-align-items: center;
	}
	#screen {
		width: 100%;
	}
}
</style>
</head>
<body>
<div id="container">
	<h1 id="header">
		<div class="logo">
			<a id="title" href="?">Pico</a>
			<a id="bros" href="javascript:startBros();">.</a>
		</div>
		<div class="menu">
			<a class="item light" href="javascript:changeSize(-2);">-</a>
			<a class="item dark" id="item" href="javascript:changeLevel(0);">x7</a>
			<a class="item light" href="javascript:changeSize(+2);">+</a>
		</div>
		<div class="menu">
			<a class="item light" id="share" href="javascript:share();">^</a>
		</div>
	</h1>
	<div id="contents">
		<div id="screen" class="picoImage picoTouch"></div>
	</div>
</div>
<h6 id="footer">
	<div id="author"></div>/
	<div id="version"></div>
</h6>
<!--script>console.log = () => {};</script!-->
<script src="daemon.js"></script>
<script src="image.js"></script>
<script src="param.js"></script>
<script src="sound.js"></script>
<script src="touch.js"></script>
<!--Data--><script>
const maxsize = 20; // Canvas max size.
var width = 7, height = 7; // Canvas size.
var xoffset = 8, yoffset = 8; // Canvas offset.
var playing = 1; // Playing count.
var pixels = []; // Pixels.
</script><!--/Data-->
<!--Menu--><script>

	// Start bros.
	function startBros() {
		let numcode = [0, width, height];
		if (pixels) {
			for (let j = yoffset; j < yoffset + height; j++) {
				for (let i = xoffset; i < xoffset + width; i++) {
					if (pixels[j][i]) {
						let k = numcode.length;
						if (pixels[j][i] == 8) {
							numcode[k] = 2;
							numcode[k + 3] = 3;
							numcode[k + 4] = i - yoffset;
							numcode[k + 5] = j - xoffset;
						} else if (pixels[j][i] == 4) {
							numcode[k] = 2;
						} else if (pixels[j][i] == 5) {
							numcode[k] = 3;
						} else {
							numcode[k] = 1;
						}
						numcode[k + 1] = i - xoffset;
						numcode[k + 2] = j - yoffset;
					}
				}
			}
		}
		picoSetNumcode(numcode);
		picoShare(false, "bros.html");
	}

	// Share.
	function share() {
		let numcode = [0, width, height];
		if (pixels) {
			for (let j = yoffset; j < yoffset + height; j++) {
				for (let i = xoffset; i < xoffset + width; i++) {
					if (pixels[j][i]) {
						let k = numcode.length;
						numcode[k] = pixels[j][i];
						numcode[k + 1] = i - xoffset;
						numcode[k + 2] = j - yoffset;
					}
				}
			}
		}
		picoSetNumcode(numcode);
		picoShare(true);
	}

	// Change canvas size.
	function changeSize(x) {
		width = width + x < 3 ? 3 : width + x >= maxsize ? maxsize : width + x;
		height = height + x < 3 ? 3 : height + x >= maxsize ? maxsize : height + x;
		xoffset = picoDiv(maxsize - width, 2);
		yoffset = picoDiv(maxsize - height, 2);
		console.log("Size: " + width + "x" + height + " + " + xoffset + "," + yoffset);
		playing = -1; // Restart.
		let e = document.getElementById("item");
		if (e) {
			e.innerText = "x" + width;
		}
		picoBeep(1.2, 0.1);	
	};
</script><!--/Menu-->
<!--Main--><script>
async function main() {

	// Load query params.
	for (let j = 0; j < maxsize; j++) {
		pixels[j] = [];
	}
	if (picoStrings()) {
		let numcode = picoNumcode();
		for (let k = 0; k < numcode.length; k += 3) {
			if (numcode[k] == 0) {
				width = numcode[k + 1] >= 0 && numcode[k + 1] < maxsize ? numcode[k + 1] : 7;
				height = numcode[k + 2] >= 0 && numcode[k + 2] < maxsize ? numcode[k + 2] : 7;
				changeSize(0);
			} else if (numcode[k] >= 1 && numcode[k] <= 9) {
				let i = numcode[k + 1] + xoffset;
				let j = numcode[k + 2] + yoffset;
				if (i >= xoffset && i < xoffset + width && j >= yoffset && j < yoffset + height) {
					pixels[j][i] = numcode[k];
				}
			}
		}
	}

	// Load pallete data.
	const colors = [255,255,255,
		255,219,171, 159,255,243, 188,188,188,
		231,0,91,    0,115,239,   0,147,59,
		167,0,0,     143,0,119,   0,63,23];
	const pallete = colors.length / 3;
	picoColor(colors);

	// Main loop.
	for (;;) {

		// Initial param.
		let select = colors.length / 3 - 1;
		//const margin = width <= 7 ? 8 : 6;
		//let thick = 42 / width - margin / 4,  grid = thick * 4 + margin, offset = 10;
		let thick = width <= 3 ? 10 : width <= 5 ? 6  : width <= 7 ? 4  : width <= 8 ? 3  : width <= 9 ? 2.5 : width <= 12 ? 2  : width <= 14 ? 1.5 : width <= 16 ? 1  : 0.5;
		let grid  = width <= 3 ? 48 : width <= 5 ? 32 : width <= 7 ? 24 : width <= 8 ? 20 : width <= 9 ? 18  : width <= 12 ? 14 : width <= 14 ? 12  : width <= 16 ? 10 : 8;
		let offset = 10;//width <= 16 ? 10 : 2;

		// Playing loop.
		for (playing = 1; playing > 0; playing++) {
			picoClear();

			// Draw pixels.
			for (let j = yoffset; j < yoffset + height; j++) {
				let y = (j - yoffset - (height - 1) / 2) * grid - 4;
				for (let i = xoffset; i < xoffset + width; i++) {
					let x = (i - xoffset - (width - 1) / 2) * grid;
					if (picoMotion(x, y, grid/2)) {
						if (pixels[j][i] != select) {
							pixels[j][i] = select;
						}
						picoPixel(pixels[j][i], x, y, thick*1.5, thick*1.5);
					} else {
						picoPixel(pixels[j][i], x, y, thick, thick);
					}
				}
			}

			// Draw pallete.
			for (let i = 0; i < pallete; i++) {
				let x = (i - (pallete - 1) / 2) * 16;
				let y = 100 - offset;
				if (picoMotion(x, y, 8, 12)) {
					if (select != i) {
						select = i;
						picoBeep(0, 0.1);
					}
				}
				if (i == select) {
					picoChar("+", i, x, y, 0, 1);
				} else {
					picoChar("-", i, x, y, 0, 1);
				}
			}

			await picoFlip();
			await picoRead();
		} // End of playing loop.
	} // End of main loop.
};
main();
</script><!--/Main-->
</body>
</html>
