<html style="overflow:hidden; user-select:none;">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
<title>Pico</title>
<link rel="icon" type="image/png" href="icon.png">
<link rel="apple-touch-icon" href="icon.png" sizes="192x192">
<link rel="manifest" href="manifest.json">
<style>
body {
	font-family: Courier, monospace, sans-serif;
	background-color: #fff;
}
a {
	color: #ccc;
	text-decoration: none;
}
#container {
	width: 100%; height: 100%;
	display: flex; display: -webkit-flex;
	flex-direction: column; -webkit-flex-direction: column;
	justify-content: flex-start; -webkit-justify-content: flex-start;
	align-items: center; -webkit-align-items: center;
}
#header {
	margin: 0px;
	flex: 0 1 auto;
	display: flex; display: -webkit-flex;
	flex-direction: row; -webkit-flex-direction: row;
	justify-content: space-between; -webkit-justify-content: space-between;
	align-items: center; -webkit-align-items: center;
}
#contents {
	position: relative;
	width: 100%; height: 100%; margin: 8px;
	flex: 1 1 auto;
	display: flex; display: -webkit-flex;
	flex-direction: row; -webkit-flex-direction: row;
	justify-content: center; -webkit-justify-content: center;
	align-items: center; -webkit-align-items: center;
	background-color: #ccc;
}
#screen {
	aspect-ratio: 1;
}
#footer {
	width: 100%; height: 12px; margin-top: -4px;
	flex: 0 1 auto;
	display: flex; display: -webkit-flex;
	flex-direction: row; -webkit-flex-direction: row;
	justify-content: flex-end; -webkit-justify-content: flex-end;
	align-items: center; -webkit-align-items: center;
	font-size: 12px;
	color: #eee;
}
.logo {
	height: 60px; margin: 0px 16px;
	display: flex; display: -webkit-flex;
	flex-direction: row; -webkit-flex-direction: row;
	justify-content: flex-start; -webkit-justify-content: flex-start;
	align-items: center; -webkit-align-items: center;
}
.logo #icon {
	width: 40px; height: 40px; padding: 10px; margin-left: -28px;
}
.logo #title {
	font-size: 24px;
	color: #888;
}
.menu {
	display: flex; display: -webkit-flex;
	flex-direction: row; -webkit-flex-direction: row;
	justify-content: space-between; -webkit-justify-content: space-between;
	align-items: flex-end; -webkit-align-items: flex-end;
}
.menu .item {
	width: 40px; height: 40px; margin: 0px;
	display: flex; display: -webkit-flex;
	flex-direction: column; -webkit-flex-direction: column;
	justify-content: center; -webkit-justify-content: center;
	align-items: center; -webkit-align-items: center;
	font-size: 16px;
}
.menu .item.dark {
	background-color: #888;
	color: #fff;
}
.menu .light {;
	color: #888;
}
.menu .item.extra {
	background-color: #ccc;
	color: #fff;
}
.menu a {
	transform: scale(1);
	opacity: 1;
}
.menu a:hover {
	transform: scale(1);
	opacity: 0.6;
}
.menu a:active {
	transform: scale(0.9);
	opacity: 1;
}
@media (max-height: 400px) {
	#container {
		display: flex; display: -webkit-flex;
		flex-direction: row; -webkit-flex-direction: row;
		justify-content: flex-start; -webkit-justify-content: flex-start;
		align-items: center; -webkit-align-items: center;
	}
	#header {
		order: 1;
	}
	.logo {
		display: none;
		width: 0%;
	}
	.menu {
		flex-direction: column; -webkit-flex-direction: column;
		justify-content: center; -webkit-justify-content: center;
		align-items: center; -webkit-align-items: center;
	}
}
@media (min-height: 400px) {
	#header {
		width: 100%;
	}
}
@media (orientation: landscape) {
	#screen {
		height: 100%;
	}
}
@media (orientation: portrait) {
	#contents {
		display: flex; display: -webkit-flex;
		flex-direction: column; -webkit-flex-direction: column;
		justify-content: center; -webkit-justify-content: center;
		align-items: center; -webkit-align-items: center;
	}
	#screen {
		width: 100%;
	}
}
</style>
</head>
<body>
<div id="container">
	<h1 id="header">
		<div class="logo">
			<a id="title" href="javascript:history.back();">Pico</a>
		</div>
		<div class="menu">
			<a class="item light" href="javascript:changeLevel(-1);">-</a>
			<a class="item dark" id="item" href="javascript:changeLevel(0);">1</a>
			<a class="item light" href="javascript:changeLevel(+1);">+</a>
		</div>
	</h1>
	<div id="contents">
		<div id="screen" class="picoImage picoTouch"></div>
	</div>
</div>
<h6 id="footer">
	<div id="author"></div>/
	<div id="version"></div>
</h6>
<script>console.log = () => {};</script>
<script src="daemon.js"></script>
<script src="image.js"></script>
<script src="param.js"></script>
<script src="sound.js"></script>
<script src="touch.js"></script>
<!--Data--><script>
var levels = [ // Level data.
null,
[0,7,7,2,0,0,3,6,6],
[0,7,7,1,6,0,1,0,6,2,0,0,3,6,6],
[0,7,7,1,1,1,2,0,0,3,6,6],
[0,7,7,1,5,1,1,5,2,1,5,3,1,5,4,1,1,5,1,2,5,1,3,5,1,4,5,1,5,5,2,0,0,3,6,6],
[0,7,7,1,2,3,1,2,4,1,3,4,2,2,2,3,4,4],
[0,7,7,1,3,2,2,0,6,3,6,6],
[0,7,7,1,2,2,1,3,2,1,5,2,1,6,2,1,2,3,1,6,3,1,2,4,1,6,4,1,2,5,1,6,5,1,2,6,1,3,6,1,4,6,1,5,6,1,6,6,2,0,0,3,4,4],
[0,7,7,1,1,1,1,5,1,1,5,2,1,5,3,1,5,4,1,1,5,1,2,5,1,3,5,1,4,5,1,5,5,2,0,0,3,4,4],
[0,7,7,1,3,3,2,1,1,3,5,1],
[0,7,7,1,3,5,2,1,3,3,5,3],
[0,7,7,1,0,0,1,6,0,1,0,3,1,6,3,1,0,6,1,3,6,1,6,6,2,2,3,3,4,3],
[0,7,7,1,0,0,1,6,0,1,0,5,1,3,5,1,6,5,1,0,6,1,3,6,1,6,6,2,2,3,3,4,3],
[0,7,7,1,0,0,1,6,0,1,0,5,1,6,5,1,0,6,1,1,6,1,5,6,1,6,6,2,2,6,3,4,6],
[0,7,7,1,1,2,1,5,2,2,0,0,3,6,6],
[0,7,7,2,1,1,3,5,1],
[0,7,7,1,2,3,1,3,3,1,4,3,2,1,1,3,5,1],
[0,7,7,1,3,2,1,2,3,1,4,3,1,2,6,1,4,6,2,2,2,3,4,2],
[0,7,7,1,2,4,1,3,4,1,4,4,2,2,2,3,4,2],
[0,7,7,1,1,3,1,2,3,1,3,3,1,4,3,1,5,3,2,1,1,3,5,1],
[0,7,7,1,1,4,1,5,4,1,1,5,1,2,5,1,3,5,1,4,5,1,5,5,2,1,1,3,5,1],
[0,7,7,1,1,1,1,5,1,1,1,5,1,5,5,2,1,2,3,5,2],
[0,7,7,1,2,0,1,0,2,1,2,2,2,3,2,3,2,3],
[0,7,7,1,3,0,1,3,2,1,4,2,1,0,3,1,2,3,1,3,3,1,4,3,1,2,4,1,3,4,1,4,4,2,6,4,3,4,6],
[0,7,7,1,2,2,1,4,2,1,2,4,1,4,4,2,2,1,3,1,2],
[0,7,7,1,3,1,1,3,2,1,1,3,1,2,3,1,3,3,2,1,1,3,5,5],
[0,7,7,1,1,3,1,3,5,2,1,5,3,1,5],
[0,7,7,1,2,1,1,1,2,1,2,2,2,1,5,3,5,1],
[0,7,7,1,3,4,2,3,2,3,3,2],
[0,7,7,1,3,4,2,3,3,3,3,3],
[0,7,7,1,1,2,1,2,2,1,4,2,1,5,2,1,2,4,1,4,4,2,1,1,3,5,1],
[0,7,7,1,1,1,1,2,1,1,3,1,1,1,2,1,2,2,1,1,3,2,2,3,3,4,3],
[0,7,7,1,3,0,1,4,0,1,5,0,1,6,0,1,4,1,1,5,1,1,6,1,1,5,2,1,6,2,1,6,3,2,2,0,3,6,4],
[0,7,7,1,0,0,1,6,0,1,0,1,1,2,1,1,4,1,1,6,1,1,0,2,1,6,2,1,0,3,1,2,3,1,4,3,1,6,3,1,0,4,1,2,4,1,4,4,1,6,4,1,0,5,1,6,5,1,0,6,1,6,6,2,2,2,3,4,2],
[0,7,7,1,3,0,1,1,1,1,5,1,1,0,3,1,2,3,1,4,3,1,6,3,1,1,5,1,3,5,1,5,5,1,3,6,2,0,6,3,0,6],
[0,7,7,1,2,0,1,3,0,1,4,0,1,2,1,1,4,1,1,4,2,1,3,3,1,3,5,2,3,3,3,3,3],
[0,7,7,1,0,0,1,1,0,1,2,0,1,3,0,1,0,1,1,1,1,1,0,2,1,0,3,1,0,4,1,0,5,1,1,5,1,0,6,1,1,6,1,2,6,1,3,6,2,2,3,3,2,3],
[0,7,7,1,1,1,1,4,1,1,5,1,1,1,4,1,1,5,1,5,5,2,1,2,3,2,1],
[0,7,7,1,0,0,1,1,0,1,2,0,1,4,0,1,5,0,1,6,0,1,1,2,1,5,2,1,1,5,1,5,5,2,3,2,3,3,0],
[0,7,7,1,1,1,1,5,1,1,2,3,1,4,3,2,2,2,3,4,2],
[0,7,7,1,3,1,2,2,3,3,4,3],
[0,7,7,1,1,4,1,5,4,1,1,5,1,5,5,2,2,5,3,4,5],
[0,7,7,1,3,1,1,5,1,1,3,3,1,0,5,1,1,5,1,0,6,1,1,6,2,1,4,3,2,5],
[0,7,7,1,2,3,1,3,3,1,4,3,2,1,4,3,5,4],
[0,7,7,1,5,1,1,5,2,1,5,3,2,1,2,3,3,2],
[0,7,7,1,1,1,1,2,1,1,3,1,1,4,1,1,5,1,1,1,2,1,5,2,1,1,3,1,5,3,2,1,5,3,5,5],
[0,7,7,1,3,0,2,3,2,3,3,2],
[0,7,7,1,5,0,1,6,0,1,6,1,1,0,5,1,0,6,2,1,5,3,3,5],
[0,7,7,1,0,0,1,1,0,1,4,0,1,5,0,1,6,0,1,0,1,1,5,1,1,6,1,1,6,2,2,2,4,3,4,4],
[0,7,7,1,3,4,1,2,5,1,3,5,1,4,5,2,2,2,3,4,2]];
var playing = 1; // Playing count.
var level = 1; // Playing level.
</script><!--/Data-->
<!--Menu--><script>

// Change level.
function changeLevel(x) {
	level = level + x < 1 ? (levels[0] ? 0 : 1) :
		level + x >= levels.length ? levels.length - 1 : level + x;
	playing = -1; // Restart.
	let e = document.getElementById("item");
	if (e) {
		e.innerText = "" + level;
	}
	picoBeep(1.2, 0.1);	
};
</script><!--/Menu-->
<!--Main--><script>
async function main() {

	// Load query params.
	if (picoStrings()) {
		levels[0] = picoNumcode();
		changeLevel(-1);
	}

	// Load pallete data.
	const colors = [255,255,255, 0,63,23, 231,0,91, 0,115,239, 143,0,119];
	picoColor(colors);

	// Main loop.
	for (;;) {

		// Initial param.
		const maxsize = 24; // Max size.
		let width = 7, height = 7, thick = 4, grid = 24;
		let pixels = [];
		let players = [[0, 0], [6, 6]];
		let primary = 0;

		// Load level data.
		for (let k = 0; k < levels[level].length / 3; k++) {
			let w = levels[level][k * 3];
			let x = levels[level][k * 3 + 1];
			let y = levels[level][k * 3 + 2];
			if (w == 0) {
				width = x >= 0 && x <= maxsize ? x : 7;
				height = y >= 0 && y <= maxsize ? y : 7;
				thick = width <= 5 ? 6  : width <= 8 ? 4  : width <= 9 ? 3  : width <= 12 ? 2  : width <= 16 ? 1  : 0.5;
				grid  = width <= 5 ? 36 : width <= 8 ? 24 : width <= 9 ? 20 : width <= 12 ? 16 : width <= 16 ? 12 : 8;
				players = [[0, 0], [width - 1, height - 1]];
				for (let j = 0; j < height; j++) {
					pixels[j] = [];
					for (let i = 0; i < width; i++) {
						pixels[j][i] = 0;
					}
				}
			} else if (x >= 0 && x < width && y >= 0 && y < height) {
				if (w == 1) {
					pixels[y][x] = 1;
				} else if (w == 2) {
					players[0] = [x, y];
				} else if (w == 3) {
					players[1] = [x, y];
				}
			}
		}
		if (players[0][0] == players[1][0] && players[0][1] == players[1][1]) {
			pixels[players[0][1]][players[0][0]] = 4;
		} else {
			pixels[players[0][1]][players[0][0]] = 2;
			pixels[players[1][1]][players[1][0]] = 3;
		}

		// Playing loop.
		for (playing = 1; playing > 0; playing++) {
			picoClear();

			// Move player.
			for (let j = 0; j < height; j++) {
				let y = (j - (height - 1) / 2) * grid;
				for (let i = 0; i < width; i++) {
					let x = (i - (width - 1) / 2) * grid;

					// Touch blank cell to move player.
					if (pixels[j][i] == 0) {
						if (picoMotion(x, y, grid/2)) {
							// Check cell next to player.
							let next = [false, false];
							for (let k = 0; k < 2; k++) {
								let dx = i - players[k][0], dy = j - players[k][1];
								if (dx * dy == 0 && (dx + dy == -1 || dx + dy == 1)) {
									next[k] = true;
								}
							}
							// Check facing cell between 2 players.
							let dx = players[0][0] - players[1][0], dy = players[0][1] - players[1][1];
							let next2 = dx * dy == 0 && (dx + dy == 2 || dx + dy == -2) ? true : false;
							// P1 and P2 move into same cell.
							if (next[0] && next[1] && next2) {
								pixels[j][i] = 4;
								players[0] = players[1] = [i, j];
							} else {
								// Move primary player first.
								for (let k = 0; k < 2; k++) {
									let k1 = primary == 0 ? k : k ? 0 : 1, k2 = k1 ? 0 : 1;
									// Player A moves forward and another player B moves backward.
									if (next[k1]) {
										pixels[j][i] = k1 == 0 ? 2 : 3;
										let i2 = players[k2][0] + players[k1][0] - i;
										let j2 = players[k2][1] + players[k1][1] - j;
										if (i2 >= 0 && i2 < width && j2 >= 0 && j2 < height) {
											if (pixels[j2][i2] == 0) {
												pixels[j2][i2] = k2 == 0 ? 2 : 3;
												players[k2] = [i2, j2];
											}
										}
										players[k1] = [i, j];
										break; // Only one player moves forward.
									}
								}
							}
						}
					}

				}
			}

			// Draw player.
			for (let j = 0; j < height; j++) {
				let y = (j - (height - 1) / 2) * grid;
				for (let i = 0; i < width; i++) {
					let x = (i - (width - 1) / 2) * grid;
					let expand = 1;
	
					// Touch color cell to update primary player.
					if (pixels[j][i] != 0) {
						if (picoMotion(x, y, grid/2)) {
							if (pixels[j][i] == 2) {
								primary = 0;
							} else if (pixels[j][i] == 3) {
								primary = 1;
							}

						// Set scale for touching or not touching player.
						} else {
							for (let k = 0; k < 2; k++) {
								if (i == players[k][0] && j == players[k][1]) {
									expand = 1.5;
									break;
								}
							}
						}
					}

					// Draw cell.
					picoPixel(pixels[j][i], x, y, thick*expand, thick*expand);
				}
			}

			await picoFlip();
			await picoRead();
		} // End of playing loop.
	} // End of main loop.
};
main();
</script><!--/Main-->
</body>
</html>
